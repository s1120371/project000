<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>💪 我的成就｜健康管家</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --green:#4caf50; --green-dark:#2e7d32; --blue:#2e5caa; --red:#e53935; --bg:#f4f6f9; }
    *{ box-sizing: border-box; }
    body{
      font-family: 'Noto Sans TC', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background-color:var(--bg);
      max-width: 960px; margin: 40px auto; padding: 0 20px;
      color:#333; line-height:1.6;
    }
    h1,h2,h3{ color:var(--green-dark); margin-bottom: 15px; }
    .card{ background:#fff; border:1px solid #e6e9ef; border-radius:14px; box-shadow:0 6px 20px rgba(30,60,90,.06); padding:20px; margin-bottom: 28px; }

    input[type="number"], input[type="date"]{
      padding:12px 14px; margin-top:6px; width:100%; max-width: 300px;
      border:1px solid #cfd7e3; border-radius:10px; font-size:16px; outline:none;
      transition:border-color .2s, box-shadow .2s;
    }
    input[type="number"]:focus, input[type="date"]:focus{ border-color:#8bc34a; box-shadow:0 0 0 4px rgba(139,195,74,.15); }

    button{
      margin-top:10px; padding:10px 16px; background:var(--green); border:none; border-radius:10px; color:#fff;
      font-size:16px; font-weight:700; cursor:pointer; transition: transform .08s, box-shadow .2s, background-color .3s;
      box-shadow:0 6px 12px rgba(76,175,80,.25);
    }
    button:hover{ transform: translateY(-1px); }
    .btn-secondary{ background:#fff; color:var(--green); border:1.5px solid var(--green); box-shadow:0 4px 10px rgba(76,175,80,.12); }
    .btn-secondary:hover{ background:#e8f5e9; }

    .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .pill{ background:#e8f5e9; color:var(--green-dark); font-weight:700; padding:6px 12px; border-radius:999px; border:1px solid #c8e6c9; }

    .progress{ width:100%; height: 14px; background:#edf2f7; border-radius:999px; overflow:hidden; border:1px solid #e2e8f0; }
    .bar{ height:100%; width:0%; background: linear-gradient(90deg, var(--green) 0%, #6fd07a 100%); transition: width .3s ease; }

    .quick-keys{ display:flex; gap:12px; flex-wrap: wrap; margin-top: 10px; }
    .key{
      padding:12px 16px; border-radius:12px; border:1px solid #dde3ee; background:#fff; cursor:pointer;
      font-weight:800; font-size:16px; letter-spacing:.2px; box-shadow:0 6px 14px rgba(20,40,70,.08);
    }
    .key:hover{ background:#f7f9ff; }
    .key.positive{ border-color:#c8e6c9; color:#1c38b7;background:linear-gradient(180deg, #ffffff 0%, #f3fbf5 100%); }
    .key.negative{ border-color:#f5c6c6; color:#b71c1c; background:linear-gradient(180deg, #fff 0%, #fff5f5 100%); }
    .key[data-type="water"]::before{ content:"💧"; margin-right:6px; }
    .key[data-type="ex"]::before{ content:"🏃"; margin-right:6px; }

    .custom-input{ display:flex; align-items:center; gap:10px; margin-top:12px; flex-wrap:wrap; }
    .custom-input input{ padding:10px 12px; border:1px solid #cfd7e3; border-radius:10px; width:140px; }
    .custom-input input:focus{ border-color:#8bc34a; box-shadow:0 0 0 4px rgba(139,195,74,.12); }

    table{ width:100%; margin-top: 10px; border-collapse: collapse; background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 4px 14px rgba(0,0,0,.06); }
    th,td{ border-bottom:1px solid #eef1f7; padding:12px; text-align:center; }
    th{ background:#f5faf6; color:#355e3b; font-weight:800; }
    tr:nth-child(even){ background:#fafcfe; }

    .badge{ display:inline-flex; align-items:center; gap:6px; background:#f4f9ff; color:#1f3e7a; padding:8px 12px; border:1px solid #cfe0ff; border-radius:12px; font-weight:700; }
    .badge.lock{ opacity:.5; filter: grayscale(100%); }

    #backButton{ position: fixed; top:20px; right: 20px; background:#2196f3; color:#fff; padding:10px 16px;
      border-radius:10px; text-decoration:none; font-weight:800; box-shadow:0 6px 14px rgba(33,150,243,.25); }
    #backButton:hover{ background:#1976d2; }

    .grid{ display:grid; grid-template-columns: 1fr; gap: 18px; }
    @media (min-width: 900px){ .grid-2{ grid-template-columns: 1fr 1fr; } }

    .spacer-24{ margin-top:24px; }

    .toast{ position: fixed; left:50%; transform:translateX(-50%); bottom:24px; background:#1f2937; color:#fff;
      padding:12px 16px; border-radius:10px; box-shadow:0 10px 24px rgba(0,0,0,.25);
      display:none; align-items:center; gap:12px; z-index:9999; }
    .toast button{ background:#fff; color:#111827; box-shadow:none; border:1px solid #e5e7eb; }
  </style>
</head>
<body>
  <a href="/home" id="backButton">🔙 返回主畫面</a>

  <h2>💪 我的成就</h2>
  <p style="margin-bottom:10px;color:#555">點擊快速鍵或輸入自訂數值來記錄飲水與運動，達成目標自動解鎖徽章！</p>

  <!-- 目標與當日進度 -->
  <section class="card">
    <div class="row" style="justify-content: space-between;">
      <div class="row">
        <span class="pill">今天：<span id="today"></span></span>
        <span class="pill">帳號：<span id="who"></span></span>
      </div>
      <div class="row">
        <div>
          <label>飲水目標(ml)</label>
          <input type="number" id="goalWater" min="500" step="100" value="2000" />
        </div>
        <div>
          <label>運動目標(分鐘)</label>
          <input type="number" id="goalExercise" min="10" step="5" value="30" />
        </div>
        <button class="btn-secondary" id="saveGoals">儲存目標</button>
      </div>
    </div>

    <div class="grid grid-2">
      <!-- 水 -->
      <div class="card" style="margin:0;">
        <h3 style="margin-top:0;">🥤 今日飲水</h3>
        <div class="row"><strong>已喝</strong><div id="waterNow" style="font-weight:700;">0</div><div>ml</div></div>
        <div class="progress" style="margin:10px 0 6px;">
          <div id="waterBar" class="bar"></div>
        </div>
        <div class="row" style="justify-content: space-between;">
          <small>目標：<span id="waterGoalText">2000</span> ml</small>
          <small><span id="waterPct">0%</span></small>
        </div>
        <div class="quick-keys">
          <button class="key positive" data-type="water" data-water="200">+200 ml</button>
          <button class="key positive" data-type="water" data-water="350">+350 ml</button>
          <button class="key positive" data-type="water" data-water="500">+500 ml</button>
          <button class="key negative" data-type="water" data-water="-200">-200 ml</button>
        </div>
        <div class="custom-input">
          <input type="number" id="customWater" placeholder="自訂 ml" min="1" />
          <button id="addCustomWater" class="btn-secondary">新增飲水</button>
        </div>
      </div>

      <!-- 運動 -->
      <div class="card" style="margin:0;">
        <h3 style="margin-top:0;">🏃‍♀️ 今日運動</h3>
        <div class="row"><strong>已運動</strong><div id="exNow" style="font-weight:700;">0</div><div>分鐘</div></div>
        <div class="progress" style="margin:10px 0 6px;">
          <div id="exBar" class="bar"></div>
        </div>
        <div class="row" style="justify-content: space-between;">
          <small>目標：<span id="exGoalText">30</span> 分</small>
          <small><span id="exPct">0%</span></small>
        </div>
        <div class="quick-keys">
          <button class="key positive" data-type="ex" data-ex="10">+10 分</button>
          <button class="key positive" data-type="ex" data-ex="20">+20 分</button>
          <button class="key positive" data-type="ex" data-ex="30">+30 分</button>
          <button class="key negative" data-type="ex" data-ex="-10">-10 分</button>
        </div>
        <div class="custom-input">
          <input type="number" id="customEx" placeholder="自訂分鐘" min="1" />
          <button id="addCustomEx" class="btn-secondary">新增運動</button>
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <h3 style="margin:0 0 10px;">🏅 今日徽章</h3>
    <div id="badges" class="row" style="gap:10px;"></div>
  </section>

  <div class="spacer-24"></div>

  <section class="grid grid-2">
    <div class="card">
      <h3 style="margin:0 0 10px;">📈 近七天趨勢</h3>
      <canvas id="trendChart" height="120"></canvas>
    </div>
    <div class="card">
      <h3 style="margin:0 0 10px;">🗓️ 記錄日期</h3>
      <input type="date" id="datePicker" />
      <small>（可切換日期補登/修正當天數據）</small>
    </div>
  </section>

  <div class="spacer-24"></div>

  <section class="card">
    <h3 style="margin:0 0 10px;">🧾 歷史記錄</h3>
    <div style="overflow:auto;">
      <table>
        <thead>
          <tr>
            <th>日期</th>
            <th>飲水 (ml)</th>
            <th>運動 (分鐘)</th>
            <th>更新時間</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="historyBody"></tbody>
      </table>
    </div>
  </section>

  <div id="toast" class="toast">
    <span id="toast-msg">已更新</span>
    <button id="undoBtn" class="btn-secondary">復原</button>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js'
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js'
    import {
      getFirestore, collection, addDoc, getDocs, query, where, orderBy, limit,
      doc, getDoc, setDoc, updateDoc, deleteDoc, serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js'

    const firebaseConfig = {
      apiKey: "AIzaSyCCNPhST7sScxFdSZJ6-NbxKgqrSYOzes4",
      authDomain: "project-1c574.firebaseapp.com",
      projectId: "project-1c574",
      storageBucket: "project-1c574.appspot.com",
      messagingSenderId: "88492956577",
      appId: "1:88492956577:web:d7e5bf270544d34ebc09e0"
    }

    const app = initializeApp(firebaseConfig)
    const auth = getAuth(app)
    const db = getFirestore(app)

    // --- DOM refs ---
    const who = document.getElementById('who')
    const todayEl = document.getElementById('today')
    const datePicker = document.getElementById('datePicker')

    const waterNow = document.getElementById('waterNow')
    const waterBar = document.getElementById('waterBar')
    const waterGoalText = document.getElementById('waterGoalText')
    const waterPct = document.getElementById('waterPct')

    const exNow = document.getElementById('exNow')
    const exBar = document.getElementById('exBar')
    const exGoalText = document.getElementById('exGoalText')
    const exPct = document.getElementById('exPct')

    const goalWaterInput = document.getElementById('goalWater')
    const goalExInput = document.getElementById('goalExercise')
    const saveGoalsBtn = document.getElementById('saveGoals')

    const badgesBox = document.getElementById('badges')
    const historyBody = document.getElementById('historyBody')

    let currentUser = null
    let chartInstance = null
    let lastAction = null
    let clickLocked = false

    const fmtDate = (d) => d.toISOString().slice(0,10)
    const tz = new Date()
    todayEl.textContent = fmtDate(tz)
    if (datePicker) datePicker.value = fmtDate(tz)

    // paths
    function userDoc(path=''){ return doc(db, 'users', currentUser.uid, ... (path? path.split('/') : [])) }
    function recordsCol(){ return collection(db, 'users', currentUser.uid, 'achievementRecords') }

    // goals
    async function loadGoals(){
      const s = await getDoc(userDoc())
      const d = s.exists()? s.data(): {}
      const gw = Number(d.goalWater || 2000)
      const ge = Number(d.goalExercise || 30)
      goalWaterInput.value = gw; goalExInput.value = ge
      waterGoalText.textContent = gw; exGoalText.textContent = ge
    }

    saveGoalsBtn.addEventListener('click', async () => {
      const gw = Math.max(500, Number(goalWaterInput.value)||2000)
      const ge = Math.max(10, Number(goalExInput.value)||30)
      await setDoc(userDoc(), { goalWater: gw, goalExercise: ge, updatedAt: new Date().toISOString() }, { merge:true })
      waterGoalText.textContent = gw; exGoalText.textContent = ge
      await loadDay(datePicker.value)
      await loadRecent()   // 同步刷新趨勢
      await loadHistory()  // 同步刷新歷史
      alert('✅ 目標已更新')
    })

    // record helpers
    async function getRecordByDate(dateStr){
      const qy = query(recordsCol(), where('date','==', dateStr))
      const snap = await getDocs(qy)
      if (snap.empty) return null
      const d = snap.docs[0]
      return { id: d.id, ...d.data() }
    }

    async function ensureRecord(dateStr){
      const r = await getRecordByDate(dateStr)
      if (r) return r
      const ref = await addDoc(recordsCol(), {
        date: dateStr, waterMl: 0, exerciseMin: 0, updatedAt: serverTimestamp()
      })
      const newSnap = await getDoc(ref)
      return { id: ref.id, ...newSnap.data() }
    }

    // mutations（寫入後：即時刷新趨勢 & 歷史）
    async function addWater(amount){
      const d = datePicker.value
      const r = await ensureRecord(d)
      const next = Math.max(0, Number(r.waterMl||0) + amount)
      await updateDoc(doc(db,'users',currentUser.uid,'achievementRecords', r.id), {
        waterMl: next, updatedAt: serverTimestamp()
      })
      await loadDay(d)
      await evaluateBadges(d)
      await loadRecent()     // 即時更新圖表
      await loadHistory()    // 即時更新歷史
    }

    async function addExercise(mins){
      const d = datePicker.value
      const r = await ensureRecord(d)
      const next = Math.max(0, Number(r.exerciseMin||0) + mins)
      await updateDoc(doc(db,'users',currentUser.uid,'achievementRecords', r.id), {
        exerciseMin: next, updatedAt: serverTimestamp()
      })
      await loadDay(d)
      await evaluateBadges(d)
      await loadRecent()
      await loadHistory()
    }

    // toast / undo
    function showToast(msg){
      const toast = document.getElementById('toast')
      const msgEl = document.getElementById('toast-msg')
      msgEl.textContent = msg
      toast.style.display = 'flex'
      clearTimeout(showToast._t)
      showToast._t = setTimeout(()=>{ toast.style.display='none' }, 5000)
    }
    document.getElementById('undoBtn').addEventListener('click', async ()=>{
      if (!lastAction) return
      const { kind, delta } = lastAction
      if (kind==='water') await addWater(-delta)
      if (kind==='ex') await addExercise(-delta)
      lastAction = null
      document.getElementById('toast').style.display='none'
    })

    // quick keys
    document.addEventListener('click', async (e) => {
      const t = e.target
      if (!t.classList.contains('key')) return
      if (clickLocked) return
      clickLocked = true; setTimeout(()=> clickLocked=false, 600)

      const dw = Number(t.getAttribute('data-water')) || 0
      const de = Number(t.getAttribute('data-ex')) || 0
      const confirmNeeded = (v, th) => (v < 0 || Math.abs(v) >= th)

      let ok = true
      if (dw) ok = !confirmNeeded(dw, 400) || confirm(`要${dw>0?'增加':'扣減'} ${Math.abs(dw)} ml 嗎？`)
      if (de) ok = ok && (!confirmNeeded(de, 20) || confirm(`要${de>0?'增加':'扣減'} ${Math.abs(de)} 分鐘嗎？`))
      if (!ok) return

      if (dw) { await addWater(dw); lastAction={kind:'water', delta:dw, date:datePicker.value}; showToast(`已更新飲水 ${dw>0?'+':''}${dw} ml`) }
      if (de) { await addExercise(de); lastAction={kind:'ex', delta:de, date:datePicker.value}; showToast(`已更新運動 ${de>0?'+':''}${de} 分`) }
    })

    // custom inputs
    document.getElementById('addCustomWater').addEventListener('click', async ()=>{
      const input = document.getElementById('customWater'); const val = Number(input.value)
      if (!val && val!==0) return alert('請輸入正確的 ml 數字')
      if (val < 0 && !confirm(`要扣減 ${Math.abs(val)} ml 嗎？`)) return
      await addWater(val); lastAction={kind:'water', delta:val, date:datePicker.value}; showToast(`已更新飲水 ${val>0?'+':''}${val} ml`); input.value=''
    })
    document.getElementById('addCustomEx').addEventListener('click', async ()=>{
      const input = document.getElementById('customEx'); const val = Number(input.value)
      if (!val && val!==0) return alert('請輸入正確的分鐘數')
      if (val < 0 && !confirm(`要扣減 ${Math.abs(val)} 分鐘嗎？`)) return
      await addExercise(val); lastAction={kind:'ex', delta:val, date:datePicker.value}; showToast(`已更新運動 ${val>0?'+':''}${val} 分`); input.value=''
    })

    // load one day to UI
    async function loadDay(dateStr){
      const r = await ensureRecord(dateStr)
      const me = await getDoc(userDoc())
      const gw = Number(me.exists()? (me.data().goalWater||2000) : 2000)
      const ge = Number(me.exists()? (me.data().goalExercise||30) : 30)

      const water = Number(r.waterMl||0), ex = Number(r.exerciseMin||0)
      waterNow.textContent = water; exNow.textContent = ex
      const wPct = Math.min(100, Math.round(water/gw*100))
      const ePct = Math.min(100, Math.round(ex/ge*100))
      waterPct.textContent = wPct + '%'; exPct.textContent = ePct + '%'
      waterBar.style.width = wPct + '%'; exBar.style.width = ePct + '%'
    }

    // 7-day chart
    async function loadRecent(){
      const labels=[], w=[], e=[]
      const base = new Date(datePicker.value)
      for (let i=6;i>=0;i--){
        const d = new Date(base); d.setDate(d.getDate()-i)
        const key = fmtDate(d)
        labels.push(key.slice(5))
        const rec = await getRecordByDate(key)
        w.push(Number(rec?.waterMl||0))
        e.push(Number(rec?.exerciseMin||0))
      }
      const ctx = document.getElementById('trendChart').getContext('2d')
      if (chartInstance) chartInstance.destroy()
      chartInstance = new Chart(ctx, {
        type:'line',
        data:{ labels, datasets:[
          { label:'飲水(ml)', data:w, borderColor:'#4CAF50', backgroundColor:'rgba(76,175,80,.18)', tension:.3, fill:true, pointRadius:3 },
          { label:'運動(分)', data:e, borderColor:'#2e5caa', backgroundColor:'rgba(46,92,170,.18)', tension:.3, fill:true, pointRadius:3 },
        ]},
        options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }
      })
    }

    // history table (order by date desc) － 只留刪除
    async function loadHistory(){
      historyBody.innerHTML = ''

      const qy = query(recordsCol(), orderBy('date','desc'), limit(30))
      const snap = await getDocs(qy)

      snap.forEach(d=>{
        const v = d.data()
        const updated = v.updatedAt?.seconds
          ? new Date(v.updatedAt.seconds*1000).toLocaleString()
          : (v.updatedAt || '')
        const tr = document.createElement('tr')
        tr.innerHTML = `
          <td>${v.date}</td>
          <td>${v.waterMl || 0}</td>
          <td>${v.exerciseMin || 0}</td>
          <td>${updated}</td>
          <td>
            <button class="delete-btn" data-id="${d.id}" style="background:#e53935;">刪除</button>
          </td>`
        historyBody.appendChild(tr)
      })

      // 單一委派監聽（不會一次就失效）
      historyBody.onclick = async (e) => {
        const t = e.target
        if (t.classList.contains('delete-btn') && t.dataset.id){
          if (!confirm('確定刪除該日期記錄？')) return
          await deleteDoc(doc(db,'users',currentUser.uid,'achievementRecords', t.dataset.id))
          await loadHistory()
          await loadRecent()
          const todayRec = await getRecordByDate(datePicker.value)
          if (!todayRec) await ensureRecord(datePicker.value)
          await loadDay(datePicker.value)
        }
      }
    }

    // badges
    const BADGES = [
      { id:'water_2l_day', name:'水分達標', desc:'單日飲水 ≥ 2000ml', icon:'💧' },
      { id:'exercise_30m_day', name:'動一動', desc:'單日運動 ≥ 30 分', icon:'🏃' },
      { id:'double_goal_day', name:'雙達標', desc:'單日飲水與運動皆達標', icon:'🥇' },
      { id:'streak_3', name:'連續3天', desc:'連續 3 天達成雙達標', icon:'🔥' }
    ]
    function badgeDoc(id){ return userDoc(`badges/${id}`) }

    async function loadBadges(){
      badgesBox.innerHTML=''
      for(const b of BADGES){
        const s = await getDoc(badgeDoc(b.id))
        const owned = s.exists() && s.data().unlocked === true
        const el = document.createElement('div')
        el.className = 'badge' + (owned? '' : ' lock')
        el.innerHTML = `${b.icon}<span>${b.name}</span>`
        el.title = b.desc + (owned? '（已解鎖）' : '（尚未解鎖）')
        badgesBox.appendChild(el)
      }
    }

    async function evaluateBadges(dateStr){
      const rec = await getRecordByDate(dateStr) || { waterMl:0, exerciseMin:0 }
      const u = await getDoc(userDoc())
      const gw = Number(u.exists()? (u.data().goalWater||2000) : 2000)
      const ge = Number(u.exists()? (u.data().goalExercise||30) : 30)

      const waterOK = (rec.waterMl||0) >= gw
      const exOK = (rec.exerciseMin||0) >= ge

      if (waterOK) await setDoc(badgeDoc('water_2l_day'), { unlocked:true, at: serverTimestamp() }, { merge:true })
      if (exOK) await setDoc(badgeDoc('exercise_30m_day'), { unlocked:true, at: serverTimestamp() }, { merge:true })
      if (waterOK && exOK) await setDoc(badgeDoc('double_goal_day'), { unlocked:true, at: serverTimestamp() }, { merge:true })

      // 連續3天雙達標
      let streakOK = true
      for (let i=0;i<3;i++){
        const d = new Date(dateStr); d.setDate(d.getDate()-i)
        const key = fmtDate(d)
        const r = await getRecordByDate(key)
        if (!r){ streakOK=false; break }
        if ((r.waterMl||0) < gw || (r.exerciseMin||0) < ge){ streakOK=false; break }
      }
      if (streakOK) await setDoc(badgeDoc('streak_3'), { unlocked:true, at: serverTimestamp() }, { merge:true })

      await loadBadges()
    }

    // date change
    datePicker.addEventListener('change', async ()=>{
      await loadDay(datePicker.value); await loadRecent()
    })

    // auth boot
    onAuthStateChanged(auth, async (user) => {
      if (!user) { alert('請先登入'); location.href='/login'; return }
      currentUser = user; document.getElementById('who')?.append(user.email)
      await loadGoals()
      await loadDay(datePicker.value)
      await loadRecent()
      await loadBadges()
      await loadHistory()
    })
  </script>
</body>
</html>
