<!-- static/nutrition.html -->
<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ± ç‡Ÿé¤Šåˆ†æï½œå¥åº·ç®¡å®¶</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --green: #4caf50;
      --dark: #2e7d32;
      --bg: #f4f6f9;
    }

    * {
      box-sizing: border-box
    }

    body {
      font-family: 'Noto Sans TC', system-ui;
      background: var(--bg);
      max-width: 960px;
      margin: 40px auto;
      padding: 0 20px;
      color: #333
    }

    h2 {
      color: var(--dark);
      margin-bottom: 8px
    }

    .card {
      background: #fff;
      border: 1px solid #e6e9ef;
      border-radius: 14px;
      box-shadow: 0 6px 20px rgba(30, 60, 90, .06);
      padding: 18px;
      margin-bottom: 18px
    }

    .uploader {
      border: 2px dashed #cfd7e3;
      background: #fafcff;
      padding: 18px;
      border-radius: 12px;
      text-align: center
    }

    #preview {
      max-width: 100%;
      border-radius: 12px;
      display: none;
      margin-top: 12px
    }

    button {
      margin-top: 12px;
      padding: 10px 16px;
      background: var(--green);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer
    }

    .muted {
      color: #666;
      font-size: 14px
    }

    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap
    }

    .pill {
      background: #e8f5e9;
      color: var(--dark);
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 700
    }

    .result {
      display: none
    }

    .kv {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 8px;
      align-items: center;
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace
    }

    .spinner {
      display: none;
      margin-left: 8px
    }
  </style>
</head>

<body>
  <a href="/home"
    style="position:fixed;right:20px;top:20px;background:#2196f3;color:#fff;padding:8px 12px;border-radius:10px;text-decoration:none;font-weight:800;">ğŸ”™
    è¿”å›ä¸»ç•«é¢</a>

  <h2>ğŸ± ç‡Ÿé¤Šåˆ†æ</h2>
  <p class="muted">ä¸Šå‚³é£Ÿç‰©ç…§ç‰‡ â†’ å…ˆç”¨ AI æ¨æ¸¬åç¨± â†’ å†æŸ¥ FatSecret ç‡Ÿé¤Šè³‡æ–™ï¼ˆä»¥æ¯ 100g ç‚ºåŸºæº–ï¼‰ã€‚</p>

  <section class="card">
    <div class="uploader">
      <input id="file" type="file" accept="image/*" />
      <img id="preview" alt="preview" />
      <div class="row">
        <button id="analyzeBtn">è¾¨è­˜ä¸¦æŸ¥ç‡Ÿé¤Š</button>
        <span id="loading" class="spinner">ğŸ”„ è™•ç†ä¸­â€¦</span>
      </div>
      <div class="muted">æ”¯æ´ï¼šæ‰‹æ©Ÿ/é›»è…¦ç›¸ç‰‡ã€‚å»ºè­°æ¸…æ¥šå–®ä¸€é£Ÿç‰©ã€‚</div>
    </div>
  </section>

  <section id="resCard" class="card result">
    <div class="row" style="justify-content:space-between">
      <div class="row"><span class="pill">æ¨æ¸¬åç¨±</span><strong id="labelZh">â€”</strong><span class="muted" id="labelEn"
          style="margin-left:8px"></span></div>
      <div class="row mono muted" id="fatsecretInfo">FatSecret æŸ¥è©¢ä¸­â€¦</div>
    </div>
    <div style="height:10px"></div>
    <div class="kv">
      <div>ç†±é‡ï¼ˆkcal/100gï¼‰</div>
      <div id="cal">â€”</div>
      <div>è›‹ç™½è³ªï¼ˆg/100gï¼‰</div>
      <div id="protein">â€”</div>
      <div>è„‚è‚ªï¼ˆg/100gï¼‰</div>
      <div id="fat">â€”</div>
      <div>ç¢³æ°´ï¼ˆg/100gï¼‰</div>
      <div id="carb">â€”</div>
    </div>
  </section>

  <!-- å‰ç«¯æ¨¡å‹ï¼šTensorFlow.js + MobileNet -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>
  <script>
    const fileEl = document.getElementById('file');
    const preview = document.getElementById('preview');
    const btn = document.getElementById('analyzeBtn');
    const spin = document.getElementById('loading');
    const resCard = document.getElementById('resCard');
    const labelZh = document.getElementById('labelZh');
    const labelEn = document.getElementById('labelEn');
    const info = document.getElementById('fatsecretInfo');
    const cal = document.getElementById('cal'), protein = document.getElementById('protein'),
      fat = document.getElementById('fat'), carb = document.getElementById('carb');

    // è‹±æ–‡â†’å¸¸è¦‹ä¸­æ–‡å°ç…§ï¼ˆå…ˆæ”¾å¹¾å€‹ï¼Œä¹‹å¾Œå¯æ“´å……æˆ–æ”¹ç”¨å­—å…¸æª”ï¼‰
    const EN_ZH = {
      "banana": "é¦™è•‰", "apple": "è˜‹æœ", "orange": "æ©™/æŸ³ä¸", "strawberry": "è‰è“", "blueberry": "è—è“",
      "grape": "è‘¡è„", "mango": "èŠ’æœ", "pineapple": "é³³æ¢¨", "watermelon": "è¥¿ç“œ",
      "bread": "éºµåŒ…", "hamburger": "æ¼¢å ¡", "pizza": "æŠ«è–©", "noodles": "éºµæ¢", "rice": "ç™½é£¯",
      "fried chicken": "ç‚¸é›", "chicken breast": "é›èƒ¸è‚‰", "salmon": "é®­é­š", "beef": "ç‰›è‚‰", "pork": "è±¬è‚‰",
      "tofu": "è±†è…", "egg": "é›è›‹", "milk": "ç‰›å¥¶", "yogurt": "å„ªæ ¼", "cheese": "èµ·å¸"
    };

    let model;
    mobilenet.load().then(m => model = m);

    fileEl.addEventListener('change', () => {
      const f = fileEl.files?.[0];
      if (!f) return;
      const url = URL.createObjectURL(f);
      preview.src = url;
      preview.style.display = 'block';
    });

    btn.addEventListener('click', async () => {
      try {
        const f = fileEl.files?.[0];
        if (!f) { alert('è«‹å…ˆé¸æ“‡åœ–ç‰‡'); return; }
        if (!model) { alert('æ¨¡å‹è¼‰å…¥ä¸­ï¼Œç¨å¾Œå†è©¦'); return; }
        spin.style.display = 'inline-block';
        resCard.style.display = 'none';

        // 1) åœ–ç‰‡è¾¨è­˜ï¼ˆTop-1ï¼‰
        await new Promise(r => setTimeout(r, 50)); // è®“åœ–ç‰‡æ¸²æŸ“
        const preds = await model.classify(preview, 1);
        const top = preds?.[0];
        const en = (top?.className || '').toLowerCase();
        const key = Object.keys(EN_ZH).find(k => en.includes(k)) || en.split(',')[0];
        const zh = EN_ZH[key] || key;

        labelZh.textContent = zh || 'ï¼ˆæœªçŸ¥ï¼‰';
        labelEn.textContent = zh ? `ï¼ˆ${en}ï¼‰` : en || 'â€”';

        // 2) æŸ¥ FatSecret
        info.textContent = 'FatSecret æŸ¥è©¢ä¸­â€¦';
        const q = encodeURIComponent(zh || en);
        const resp = await fetch(`/api/fatsecret/search?query=${q}`);
        if (!resp.ok) throw new Error('FatSecret æŸ¥è©¢å¤±æ•—');
        const data = await resp.json();

        // æœŸå¾… data æ ¼å¼ï¼š{ name, per100g: { calories, protein, fat, carbs }, raw }
        const d = data?.per100g || {};
        cal.textContent = d.calories ?? 'â€”';
        protein.textContent = d.protein ?? 'â€”';
        fat.textContent = d.fat ?? 'â€”';
        carb.textContent = d.carbs ?? 'â€”';
        info.textContent = data?.name ? `ä¾†æºï¼š${data.name}` : 'â€”';

        resCard.style.display = 'block';
      } catch (err) {
        console.error(err);
        alert('è¾¨è­˜æˆ–æŸ¥è©¢ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æ›å¼µæ›´æ¸…æ¥šçš„ç…§ç‰‡å†è©¦ä¸€æ¬¡');
      } finally {
        spin.style.display = 'none';
      }
    });
  </script>
</body>

</html>