<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>健康管家 Health Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Noto Sans TC', sans-serif;
    }

    body {
      background-color: #f7f9fc;
      color: #333;
      line-height: 1.6;
    }

    .container {
      width: 90%;
      max-width: 1000px;
      margin: 0 auto;
    }

    header {
      background-color: #4CAF50;
      color: white;
      padding: 15px 0;
    }

    header .container {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header nav a {
      color: white;
      margin-left: 20px;
      text-decoration: none;
      font-weight: bold;
    }

    header nav a:hover {
      text-decoration: underline;
    }

    .top-function-nav {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      background: #fff;
      padding: 15px 0;
      gap: 20px;
      border-bottom: 1px solid #ddd;
    }

    .top-function-nav a {
      text-decoration: none;
      color: #4CAF50;
      font-size: 1.1rem;
      font-weight: bold;
      transition: color 0.2s;
    }

    .top-function-nav a:hover {
      color: #2e7d32;
    }

    .hero {
      background: #e8f5e9;
      padding: 60px 0;
      text-align: center;
    }

    footer {
      width: 100%;
      background-color: #f1f1f1;
      color: #666;
      text-align: center;
      padding: 20px 0;
      font-size: 0.9rem;
      margin-top: 40px;
    }

    .user-data {
      margin-top: 40px; /* 新增的間距 */
    }

    .info-box {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #ddd;
      margin-top: 20px; /* 新增的間距 */
    }

    .info-box p {
      margin-bottom: 10px;
    }

    
    .update-date {
    font-size: 0.8rem;
    color: #888;
    text-align: right;
    margin-top: 15px;
  }

  /* 更新日期字樣 */
  .update-date span {
    font-weight: normal;
  }

    .news-preview {
      padding: 40px 0;
      background-color: #f4f9ff;
      text-align: left;
      margin-bottom: 40px;
    }

    .news-preview h3 {
      font-size: 1.8rem;
      color: #2e5caa;
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
      text-align: center;
    }

    .news-list {
      display: flex;
      flex-direction: column;
      gap: 20px;
      align-items: center;
    }

    .news-item {
      background: #ffffff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      transition: transform 0.3s, box-shadow 0.3s;
      position: relative;
      overflow: hidden;
      border-left: 5px solid #2e5caa;
      width: 100%;
      max-width: 1000px;
      margin: 0 auto;
      text-align: left;
    }

    .news-item:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
    }

    .news-item h4 {
      font-size: 1.2rem;
      margin-bottom: 8px;
      color: #2e5caa;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .news-item h4::before {
      content: "🥬";
      font-size: 1.4rem;
      margin-right: 8px;
    }

    .news-item p {
      font-size: 0.95rem;
      color: #555;
      margin-bottom: 12px;
      line-height: 1.6;
    }

    .news-btn {
      display: inline-block;
      background-color: #2e5caa;
      color: #ffffff;
      padding: 8px 16px;
      font-size: 0.9rem;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
      text-decoration: none;
      font-weight: bold;
      text-align: center;
    }

    .news-btn:hover {
      background-color: #1f3e7a;
    }

    .news-btn:focus {
      outline: none;
      box-shadow: 0 0 0 4px rgba(46, 92, 170, 0.2);
    }
  </style>
</head>

<body>
  <header>
    <div class="container">
      <h1>健康管家</h1>
      <nav>
        <span id="user-identity" style="margin-right: 20px;"></span>
        <span id="login-links"><a href="/login">登入 / 註冊</a></span>
        <span id="auth-links" style="display: none;">
          <a href="/edit-profile">個人資料</a>
          <a href="#" id="logoutBtn">登出</a>
        </span>
      </nav>
    </div>
  </header>

  <nav class="top-function-nav">
    <a href="/nutrition">🍱 營養分析</a>
    <a href="/">❤️ 健康建議</a>
    <a href="/achievements">💪 我的成就</a>
    <a href="/bmi">📐 BMI 計算</a>
  </nav>

  <section class="hero">
    <div class="container">
      <h2 id="welcome-title">讓飲食更智慧，健康看得見</h2>
      <p>結合 AI ，提供全面性的健康飲食分析。</p>
    </div>
  </section>

  <section class="user-data container">
    <h2>👤 使用者個人資料</h2>
    <div id="userInfo" class="info-box" style="display:none;">
      <p><strong>帳號：</strong><span id="username"></span></p>
      <p><strong>姓名：</strong><span id="fullname"></span></p>
      <p><strong>性別：</strong><span id="gender"></span></p>
      <p><strong>生日：</strong><span id="birthdate"></span></p>
      <p><strong>飲食習慣：</strong><span id="diet"></span></p>
      <p><strong>健康目標：</strong><span id="goal"></span></p>
      <p><strong>過敏源：</strong><span id="allergens"></span></p>
    </div>
  </section>

  <section class="news-preview">
    <div class="container">
      <h3>📢 相關新聞</h3>
      <div class="news-list">
        <div class="news-item">
          <h4>正餐時間外老覺得餓？恐是蛋白質不足 營養師教簡單補足擺脫疲勞</h4>
          <p>蛋白質是維持健康與代謝的重要營養素，攝取不足易感疲憊與飢餓。專家建議每餐攝取30公克蛋白質，從早餐起搭配乳製品、堅果等天然食材，有助提升飽足感與修復力，維持身體活力。</p>
          <a href="https://udn.com/news/story/7266/8738067" class="news-btn" target="_blank"
            rel="noopener noreferrer">閱讀全文</a>
        </div>
        <div class="news-item">
          <h4>養生女自製健康早餐 「1吃法」險得糖尿病！很多人中</h4>
          <p>五穀粉雖健康，但磨粉後易轉為「糖水」，恐導致肥胖與血糖飆升。建議選原型穀物、控制份量，搭配蛋白質與好油脂，避免天天大量飲用。</p>
          <a href="https://health.udn.com/health/story/6037/8227694" class="news-btn" target="_blank"
            rel="noopener noreferrer">閱讀全文</a>
        </div>
        <div class="news-item">
          <h4>減肥失敗真相曝光！蛋白質吃不夠才是主因</h4>
          <p>研究指出，蛋白質攝取不足會導致過度進食、熱量超標，反而變胖。減重時應確保飲食中蛋白質達15%，提升飽足感、穩定食慾，才能有效控制體重，避免高脂與高糖飲食。</p>
          <a href="https://tw.news.yahoo.com/%E6%B8%9B%E8%82%A5%E5%A4%B1%E6%95%97%E7%9C%9F%E7%9B%B8%E6%9B%9D%E5%85%89-%E8%9B%8B%E7%99%BD%E8%B3%AA%E5%90%83%E4%B8%8D%E5%A4%A0%E6%89%8D%E6%98%AF%E4%B8%BB%E5%9B%A0-002333952.html"
            class="news-btn" target="_blank" rel="noopener noreferrer">閱讀全文</a>
        </div>
      </div>
      <p class="update-date"><span>資料更新日期：</span><span id="updateDate">2025-09-26</span></p>
    </div>
  </section>
  <footer>
    <p>&copy; 2025 健康管家 Health Tracker</p>
  </footer>

  <script>
    
    document.addEventListener('DOMContentLoaded', async () => {
      const idToken = sessionStorage.getItem('firebaseIdToken');
      const userIdentity = document.getElementById("user-identity");
      const authLinks = document.getElementById("auth-links");
      const loginLinks = document.getElementById("login-links");
      const welcomeTitle = document.getElementById("welcome-title");
      const userInfoBox = document.getElementById("userInfo");


      if (!idToken) {
        authLinks.style.display = "none";
        loginLinks.style.display = "inline";
        // 不自動跳轉，讓未登入使用者也能看到新聞
        welcomeTitle.textContent = "歡迎訪客！登入後可查看個人化資訊";
        userInfoBox.innerHTML = '<p>請<a href="/login">登入</a>以查看您的個人資料。</p>';
        userInfoBox.style.display = "block";
        return;
      }

      try {
        // 使用 GET 方法並將 token 放在 Authorization header
        const response = await fetch('/api/user-profile', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${idToken}`
          }
        });

        if (!response.ok) {
          const errData = await response.json();
          throw new Error(errData.error || '無法獲取使用者資料，請重新登入');
        }

        const data = await response.json();

        // 更新 UI 顯示登入狀態
        authLinks.style.display = "inline";
        loginLinks.style.display = "none";

        const username = data.username || data.email;
        welcomeTitle.textContent = `👋 歡迎回來，${username}`;
        userIdentity.textContent = username;

        // 填充個人資料
        userInfoBox.style.display = "block";
        document.getElementById("username").textContent = data.username || "未填寫";
        document.getElementById("fullname").textContent = data.fullname || "未填寫";
        document.getElementById("gender").textContent = data.gender || "未填寫";
        document.getElementById("birthdate").textContent = data.birthdate || "未填寫";
        document.getElementById("diet").textContent = data.diet || "未填寫";
        document.getElementById("goal").textContent = data.goal || "未填寫";
        document.getElementById("allergens").textContent = (data.allergens || []).join(", ") || "無";

      } catch (error) {
        console.error('API 呼叫失敗:', error);
        // Token 可能無效或過期，清除它並提示重新登入
        sessionStorage.removeItem('firebaseIdToken');
        authLinks.style.display = "none";
        loginLinks.style.display = "inline";
        userInfoBox.innerHTML = `<p>⚠️ 驗證已過期，請<a href="/login">重新登入</a>以查看您的個人資料。</p>`;
        userInfoBox.style.display = "block";
      }
    });

    // 登出按鈕的事件監聽
    const logoutBtn = document.getElementById("logoutBtn");
    logoutBtn?.addEventListener("click", () => {
      sessionStorage.removeItem('firebaseIdToken');
      window.location.href = "/login";
    });
  </script>
</body>

</html>