<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <title>BMI è¨ˆç®—èˆ‡æ­·å²ç´€éŒ„</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: "Noto Sans TC", sans-serif;
      background-color: #f4f6f9;
      max-width: 860px;
      margin: 40px auto;
      padding: 0 20px;
      color: #333;
    }

    h2,
    h3 {
      color: #2e7d32;
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-top: 20px;
      font-weight: bold;
    }

    input[type="number"] {
      padding: 10px;
      margin-top: 5px;
      width: 100%;
      max-width: 300px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
    }

    button {
      margin-top: 25px;
      padding: 12px 24px;
      background: #4caf50;
      border: none;
      border-radius: 6px;
      color: white;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background: #388e3c;
    }

    #result {
      margin-top: 20px;
      font-size: 20px;
      font-weight: bold;
      color: #333;
    }

    table {
      width: 100%;
      margin-top: 40px;
      border-collapse: collapse;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: center;
    }

    th {
      background-color: #4caf50;
      color: white;
      font-weight: bold;
    }

    tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    canvas {
      margin-top: 40px;
    }

    #backButton {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #2196f3;
      color: white;
      padding: 10px 16px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: bold;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      transition: background-color 0.3s ease;
    }

    #backButton:hover {
      background-color: #1976d2;
    }

    .delete-btn {
      background-color: #e53935;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }

    .delete-btn:hover {
      background-color: #c62828;
    }
  </style>
</head>

<body>
  <a href="/home" id="backButton">ğŸ”™ è¿”å›ä¸»ç•«é¢</a>
  <h2>BMI è¨ˆç®—å™¨</h2>
  <p id="status">ç™»å…¥ç‹€æ…‹è¼‰å…¥ä¸­...</p>
  <label>èº«é«˜ (cm)<input type="number" id="height" min="50" max="300" required /></label>
  <label>é«”é‡ (kg)<input type="number" id="weight" min="10" max="300" required /></label>
  <button id="calculateBtn">è¨ˆç®—ä¸¦å„²å­˜ BMI</button>
  <p id="result"></p>
  <h3>æ­·å² BMI ç´€éŒ„</h3>
  <table>
    <thead>
      <tr>
        <th>æ—¥æœŸ</th>
        <th>æ™‚é–“</th>
        <th>èº«é«˜</th>
        <th>é«”é‡</th>
        <th>BMI (åˆ†é¡)</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="recordListBody"></tbody>
  </table>
  <h3>BMI è¶¨å‹¢åœ–</h3>
  <canvas id="bmiChart" width="700" height="350"></canvas>

  <script>
    const statusEl = document.getElementById('status');
    const idToken = sessionStorage.getItem('firebaseIdToken');
    let chartInstance = null;

    // --- API Helper ---
    async function apiFetch(endpoint, options = {}) {
      const headers = { 'Content-Type': 'application/json', ...options.headers };
      if (idToken) headers['Authorization'] = `Bearer ${idToken}`;
      const response = await fetch(endpoint, { ...options, headers });
      if (!response.ok) {
        const errData = await response.json();
        throw new Error(errData.error || `HTTP error! status: ${response.status}`);
      }
      if (response.status === 204 || response.headers.get('content-length') === '0') return null;
      return response.json();
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', async () => {
      if (!idToken) {
        alert("è«‹å…ˆç™»å…¥ï¼");
        window.location.href = "/login";
        return;
      }
      try {
        const profile = await apiFetch('/api/user-profile');
        statusEl.textContent = `ğŸ‘¤ å·²ç™»å…¥ï¼š${profile.email || 'ä½¿ç”¨è€…'}`;
        await loadBMIRecords();
      } catch (e) {
        statusEl.textContent = 'âŒ é©—è­‰å¤±æ•—ï¼Œè«‹é‡æ–°ç™»å…¥';
        console.error(e);
        sessionStorage.removeItem('firebaseIdToken');
        setTimeout(() => window.location.href = "/login", 1500);
      }
    });

    // --- Event Listeners ---
    document.getElementById('calculateBtn').addEventListener('click', calculateAndSaveBMI);
    document.getElementById('recordListBody').addEventListener('click', handleRecordDelete);

    // --- Core Functions ---
    async function calculateAndSaveBMI() {
      const height = parseFloat(document.getElementById('height').value);
      const weight = parseFloat(document.getElementById('weight').value);
      if (!height || !weight) {
        alert("è«‹è¼¸å…¥æ­£ç¢ºçš„èº«é«˜èˆ‡é«”é‡ï¼");
        return;
      }
      const bmi = weight / ((height / 100) ** 2);
      const roundedBMI = parseFloat(bmi.toFixed(2));
      document.getElementById('result').textContent = `ä½ çš„ BMI ç‚ºï¼š${roundedBMI} (${getBMICategory(roundedBMI)})`;

      const now = new Date();
      const dateStr = now.toISOString().split('T')[0];
      const timeStr = now.toTimeString().split(' ')[0];

      try {
        await apiFetch('/api/bmi-records', {
          method: 'POST',
          body: JSON.stringify({ height, weight, bmi: roundedBMI, date: dateStr, time: timeStr })
        });
        alert("âœ… BMI ç´€éŒ„å·²å„²å­˜ï¼");
        await loadBMIRecords(); // é‡æ–°è¼‰å…¥ä»¥æ›´æ–°åˆ—è¡¨å’Œåœ–è¡¨
      } catch (err) {
        alert(`âŒ å„²å­˜å¤±æ•—ï¼š${err.message}`);
      }
    }

    async function loadBMIRecords() {
      try {
        const records = await apiFetch('/api/bmi-records');
        const listTbody = document.getElementById("recordListBody");

        listTbody.innerHTML = records.map(record => `
                <tr>
                    <td>${record.date}</td>
                    <td>${record.time}</td>
                    <td>${record.height} cm</td>
                    <td>${record.weight} kg</td>
                    <td>${record.bmi} (${getBMICategory(record.bmi)})</td>
                    <td><button class="delete-btn" data-id="${record.id}">åˆªé™¤</button></td>
                </tr>
            `).join('');

        const labels = records.map(r => `${r.date} ${r.time}`).reverse();
        const data = records.map(r => r.bmi).reverse();
        drawChart(labels, data);
      } catch (err) {
        alert(`âŒ è®€å–ç´€éŒ„å¤±æ•—ï¼š${err.message}`);
      }
    }

    async function handleRecordDelete(event) {
      const target = event.target;
      if (target.classList.contains('delete-btn')) {
        const recordId = target.dataset.id;
        if (recordId && confirm("ç¢ºå®šè¦åˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ")) {
          try {
            await apiFetch(`/api/bmi-records/${recordId}`, { method: 'DELETE' });
            alert('âœ… ç´€éŒ„å·²åˆªé™¤');
            await loadBMIRecords(); // é‡æ–°è¼‰å…¥
          } catch (err) {
            alert(`âŒ åˆªé™¤å¤±æ•—ï¼š${err.message}`);
          }
        }
      }
    }

    // --- Helper Functions ---
    function getBMICategory(bmi) {
      if (bmi < 18.5) return "éè¼•";
      if (bmi < 24) return "æ­£å¸¸";
      if (bmi < 27) return "éé‡";
      if (bmi < 30) return "è¼•åº¦è‚¥èƒ–";
      if (bmi < 35) return "ä¸­åº¦è‚¥èƒ–";
      return "é‡åº¦è‚¥èƒ–";
    }

    function drawChart(labels, data) {
      const ctx = document.getElementById("bmiChart").getContext("2d");
      if (chartInstance) chartInstance.destroy();

      chartInstance = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "BMI è¶¨å‹¢",
            data,
            borderColor: "#4caf50",
            backgroundColor: "rgba(76,175,80,0.2)",
            fill: true, tension: 0.3, pointRadius: 4, pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: false, suggestedMin: 10, suggestedMax: 40 } },
          plugins: {
            tooltip: {
              callbacks: { label: ctx => `${ctx.parsed.y} (${getBMICategory(ctx.parsed.y)})` }
            }
          }
        }
      });
    }
  </script>
</body>

</html>