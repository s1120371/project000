<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Firebase è¨»å†Šèˆ‡ç™»å…¥æ•´åˆ</title>
</head>
<body>
  <h2>ä½¿ç”¨è€…è¨»å†Š</h2>
  <form id="registerForm">
    <input type="text" name="username" placeholder="å¸³è™Ÿ" required />
    <input type="email" name="email" placeholder="Email" required />
    <input type="password" name="password" placeholder="å¯†ç¢¼" required />
    <input type="password" name="confirm_password" placeholder="ç¢ºèªå¯†ç¢¼" required />
    <input type="text" name="fullname" placeholder="å§“å" required />
    <input type="date" name="birthdate" required />

    <select name="gender" required>
      <option value="">é¸æ“‡æ€§åˆ¥</option>
      <option value="male">ç”·</option>
      <option value="female">å¥³</option>
      <option value="other">å…¶ä»–</option>
    </select>

    <p>è«‹å‹¾é¸ä½ æœƒéæ•çš„é£Ÿç‰©ï¼š</p>
    <label><input type="checkbox" name="allergens" value="è›‹"> è›‹</label>
    <label><input type="checkbox" name="allergens" value="å¥¶"> å¥¶</label>
    <label><input type="checkbox" name="allergens" value="èŠ±ç”Ÿ"> èŠ±ç”Ÿ</label>
    <label><input type="checkbox" name="allergens" value="æµ·é®®"> æµ·é®®</label>
    <label><input type="checkbox" name="allergens" value="å …æœ"> å …æœ</label>

    <br><br>
    <label>é£²é£Ÿç¿’æ…£ï¼š</label>
    <select name="diet" required>
      <option value="">è«‹é¸æ“‡</option>
      <option value="omnivore">ä¸€èˆ¬è‘·é£Ÿ</option>
      <option value="lacto-ovo">è›‹å¥¶ç´ </option>
      <option value="vegan">å…¨ç´ </option>
    </select>

    <br><br>
    <label>å¥åº·ç›®æ¨™ï¼š</label>
    <select name="goal" required>
      <option value="">è«‹é¸æ“‡</option>
      <option value="weight-loss">æ¸›é‡</option>
      <option value="muscle-gain">å¢è‚Œ</option>
      <option value="control-sugar">æ§åˆ¶è¡€ç³–</option>
      <option value="general-health">ä¸€èˆ¬å¥åº·</option>
    </select>

    <br><br>
    <button type="submit">è¨»å†Š</button>
  </form>

  <h2>ä½¿ç”¨è€…ç™»å…¥</h2>
  <form id="loginForm">
    <input type="email" id="loginEmail" placeholder="Email" required />
    <input type="password" id="loginPassword" placeholder="å¯†ç¢¼" required />
    <button type="submit">ç™»å…¥</button>
  </form>

  <h3 id="status">ğŸ”’ å°šæœªç™»å…¥</h3>
  <button id="logoutBtn" style="display:none;">ç™»å‡º</button>

  <div id="userData" style="display:none;">
    <h3>ğŸ‘¤ ä½¿ç”¨è€…è³‡æ–™</h3>
    <pre id="userInfo"></pre>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCCNPhST7sScxFdSZJ6-NbxKgqrSYOzes4",
      authDomain: "project-1c574.firebaseapp.com",
      projectId: "project-1c574",
      storageBucket: "project-1c574.appspot.com",
      messagingSenderId: "88492956577",
      appId: "1:88492956577:web:d7e5bf270544d34ebc09e0"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const status = document.getElementById("status");
    const userDataDiv = document.getElementById("userData");
    const userInfo = document.getElementById("userInfo");
    const logoutBtn = document.getElementById("logoutBtn");

    // è¨»å†Šäº‹ä»¶
    document.getElementById("registerForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.target;
      const email = form.email.value;
      const password = form.password.value;
      const confirmPassword = form.confirm_password.value;
      const username = form.username.value;
      const fullname = form.fullname.value;
      const birthdate = form.birthdate.value;
      const gender = form.gender.value;
      const diet = form.diet.value;
      const goal = form.goal.value;
      const allergens = Array.from(form.querySelectorAll('input[name="allergens"]:checked')).map(cb => cb.value);

      if (password !== confirmPassword) {
        status.textContent = "âŒ å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸ç¬¦";
        return;
      }

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        await setDoc(doc(db, "users", user.uid), {
          username,
          email,
          fullname,
          birthdate,
          gender,
          allergens,
          diet,
          goal,
          createdAt: new Date().toISOString()
        });

        status.textContent = `âœ… è¨»å†ŠæˆåŠŸï¼Œæ­¡è¿ ${fullname}`;
        form.reset();
      } catch (err) {
        status.textContent = `âŒ è¨»å†Šå¤±æ•—ï¼š${err.message}`;
      }
    });

    // ç™»å…¥äº‹ä»¶
    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;

      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        status.textContent = `âœ… ç™»å…¥æˆåŠŸï¼š${user.email}`;

        // è·³è½‰è‡³é¦–é 
        setTimeout(() => {
          window.location.href = "home.html";
        }, 1000);
      } catch (err) {
        status.textContent = `âŒ ç™»å…¥å¤±æ•—ï¼š${err.message}`;
      }
    });

    // ç™»å‡ºäº‹ä»¶
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    // ç™»å…¥ç‹€æ…‹è®ŠåŒ–
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        status.textContent = `ğŸ”“ å·²ç™»å…¥ï¼š${user.email}`;
        logoutBtn.style.display = "inline-block";

        const docRef = doc(db, "users", user.uid);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          userDataDiv.style.display = "block";
          userInfo.textContent = JSON.stringify(docSnap.data(), null, 2);
        } else {
          userInfo.textContent = "âš ï¸ æ‰¾ä¸åˆ°ä½¿ç”¨è€…è³‡æ–™";
        }
      } else {
        status.textContent = "ğŸ”’ å°šæœªç™»å…¥";
        userDataDiv.style.display = "none";
        logoutBtn.style.display = "none";
      }
    });
  </script>
</body>
</html>
